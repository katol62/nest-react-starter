{"ast":null,"code":"import { ApolloClient, InMemoryCache, gql, makeVar, createHttpLink, ApolloLink, from } from \"@apollo/client\";\nimport PersistentStorage from '../store/Storage';\nimport { Constants } from \"../helpers/Models\";\nimport { onError } from \"@apollo/client/link/error\";\nimport { NotificationService } from \"../services/NotificationService\";\nimport { LoadingService } from \"../services/LoadingService\";\nimport { isExpired } from \"react-jwt\";\ndebugger;\nconst httpLink = createHttpLink({\n  uri: '/graphql'\n}); // const baseHeaders = {\n// \t'Content-Type': 'application/json',\n// \t'Access-Control-Allow-Origin': '*',\n// \t'Access-Control-Allow-Credentials': true,\n// }\n\nconst middleware = new ApolloLink((operation, forward) => {\n  LoadingService.showLoading(true);\n  console.log('Starting', operation, new Date());\n  return forward(operation);\n});\nconst afterware = new ApolloLink((operation, forward) => {\n  return forward(operation).map(response => {\n    LoadingService.showLoading(false);\n    console.log('Completed', operation, new Date());\n    return response;\n  });\n});\nconst authLink = new ApolloLink((operation, forward) => {\n  operation.setContext(({\n    headers\n  }) => ({\n    headers: {\n      authorization: `Bearer ${storage.getItem(Constants.TOKEN)}` || null,\n      ...headers\n    }\n  }));\n  return forward(operation);\n});\nconst errorLink = onError(({\n  graphQLErrors,\n  networkError\n}) => {\n  if (graphQLErrors) {\n    graphQLErrors.map(({\n      message,\n      locations,\n      path\n    }) => console.error(`[GraphQL error]: Message: ${message}, Location: ${locations}, Path: ${path}`));\n    debugger;\n    const statusCode = graphQLErrors[0].extensions ? graphQLErrors[0].extensions.exception.response.statusCode : null;\n\n    if (statusCode && statusCode === 401) {// auth.logOut();\n    }\n\n    NotificationService.sendNotification({\n      variant: 'danger',\n      title: 'Error',\n      message: graphQLErrors[0].message\n    });\n  }\n\n  if (networkError) {\n    console.error(`[Network error]: ${networkError}`);\n    NotificationService.sendNotification({\n      variant: 'danger',\n      title: 'Error',\n      message: networkError.message\n    });\n  }\n});\nconst storage = PersistentStorage.instance; // const auth = Auth.instance;\n\nexport const isLoggedInVar = makeVar(!!(storage.getItem(Constants.TOKEN) && !isExpired(storage.getItem(Constants.TOKEN))));\nexport const tokenVar = makeVar(storage.getItem(Constants.TOKEN));\nexport const loggedUserVar = makeVar(storage.getItem(Constants.USER));\nconst typeDefs = gql`\n\t\tinput UserFilterDto {\n\t\t\tid: Float,\n\t\t\tfirstName: String,\n\t\t\tlastName: String,\n\t\t\temail: String,\n\t\t\tphone: String,\n\t\t\trole: String\n\t  \t}\n`;\nconst typePolicies = {\n  Query: {\n    fields: {\n      isLoggedIn: {\n        read() {\n          return isLoggedInVar();\n        }\n\n      },\n      me: {\n        read() {\n          return tokenVar();\n        }\n\n      },\n      token: {\n        read() {\n          return loggedUserVar();\n        }\n\n      }\n    }\n  }\n};\nconst cache = new InMemoryCache({\n  typePolicies\n});\nexport class Gql {\n  constructor() {\n    this.apollo = void 0;\n    this.apollo = this.initClient();\n  }\n\n  initClient() {\n    const client = new ApolloClient({\n      cache,\n      typeDefs,\n      link: from([authLink, errorLink, middleware, afterware, httpLink])\n    });\n    return client;\n  }\n\n} // export const client = new Gql().apollo;\n\nexport const client = new ApolloClient({\n  cache,\n  typeDefs,\n  link: from([authLink, errorLink, middleware, afterware, httpLink])\n});","map":{"version":3,"sources":["/Users/apple/Documents/work/git/nest-react/client/src/process/apollo/GqlClient.ts"],"names":["ApolloClient","InMemoryCache","gql","makeVar","createHttpLink","ApolloLink","from","PersistentStorage","Constants","onError","NotificationService","LoadingService","isExpired","httpLink","uri","middleware","operation","forward","showLoading","console","log","Date","afterware","map","response","authLink","setContext","headers","authorization","storage","getItem","TOKEN","errorLink","graphQLErrors","networkError","message","locations","path","error","statusCode","extensions","exception","sendNotification","variant","title","instance","isLoggedInVar","tokenVar","loggedUserVar","USER","typeDefs","typePolicies","Query","fields","isLoggedIn","read","me","token","cache","Gql","constructor","apollo","initClient","client","link"],"mappings":"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","sourcesContent":["import {ApolloClient, InMemoryCache, NormalizedCacheObject, gql, makeVar, createHttpLink, ApolloLink, from} from \"@apollo/client\";\nimport PersistentStorage from '../store/Storage'\nimport {Constants, IUser} from \"../helpers/Models\";\nimport {onError} from \"@apollo/client/link/error\";\nimport {NotificationService} from \"../services/NotificationService\";\nimport {LoadingService} from \"../services/LoadingService\";\nimport {isExpired} from \"react-jwt\";\nimport Auth from \"../store/Auth\";\n\ndebugger;\n\nconst httpLink = createHttpLink({\n\turi: '/graphql',\n});\n\n// const baseHeaders = {\n// \t'Content-Type': 'application/json',\n// \t'Access-Control-Allow-Origin': '*',\n// \t'Access-Control-Allow-Credentials': true,\n// }\n\nconst middleware = new ApolloLink((operation, forward) => {\n\tLoadingService.showLoading(true);\n\tconsole.log('Starting', operation, new Date());\n\n\treturn forward(operation);\n});\n\nconst afterware = new ApolloLink((operation, forward) => {\n\treturn forward(operation).map(response => {\n\t\tLoadingService.showLoading(false);\n\t\tconsole.log('Completed', operation, new Date());\n\n\t\treturn response;\n\t});\n});\n\nconst authLink = new ApolloLink((operation, forward) => {\n\toperation.setContext(({ headers }: any) => ({ headers: {\n\t\t\tauthorization: `Bearer ${storage.getItem(Constants.TOKEN)}` || null,\n\t\t\t...headers\n\t\t}}));\n\treturn forward(operation);\n});\n\nconst errorLink = onError(({ graphQLErrors, networkError }) => {\n\tif (graphQLErrors) {\n\t\tgraphQLErrors.map(({ message, locations, path }) =>\n\t\t\tconsole.error(\n\t\t\t\t`[GraphQL error]: Message: ${message}, Location: ${locations}, Path: ${path}`,\n\t\t\t),\n\t\t);\n\t\tdebugger;\n\t\tconst statusCode = graphQLErrors[0].extensions ? graphQLErrors[0].extensions.exception.response.statusCode : null;\n\t\tif (statusCode && statusCode === 401) {\n\t\t\t// auth.logOut();\n\t\t}\n\t\tNotificationService.sendNotification({\n\t\t\tvariant: 'danger',\n\t\t\ttitle: 'Error',\n\t\t\tmessage: graphQLErrors[0].message\n\t\t})\n\t}\n\tif (networkError) {\n\t\tconsole.error(`[Network error]: ${networkError}`);\n\t\tNotificationService.sendNotification({\n\t\t\tvariant: 'danger',\n\t\t\ttitle: 'Error',\n\t\t\tmessage: networkError.message\n\t\t})\n\t}\n});\n\nconst storage = PersistentStorage.instance;\n// const auth = Auth.instance;\n\nexport const isLoggedInVar = makeVar<boolean>(!!(storage.getItem(Constants.TOKEN) && !isExpired(storage.getItem(Constants.TOKEN))));\nexport const tokenVar = makeVar<string | null>(storage.getItem(Constants.TOKEN));\nexport const loggedUserVar = makeVar<IUser | null>(storage.getItem(Constants.USER));\n\nconst typeDefs = gql`\n\t\tinput UserFilterDto {\n\t\t\tid: Float,\n\t\t\tfirstName: String,\n\t\t\tlastName: String,\n\t\t\temail: String,\n\t\t\tphone: String,\n\t\t\trole: String\n\t  \t}\n`;\n\nconst typePolicies = {\n\tQuery: {\n\t\tfields: {\n\t\t\tisLoggedIn: {\n\t\t\t\tread() {\n\t\t\t\t\treturn isLoggedInVar()\n\t\t\t\t}\n\t\t\t},\n\t\t\tme: {\n\t\t\t\tread() {\n\t\t\t\t\treturn tokenVar()\n\t\t\t\t}\n\t\t\t},\n\t\t\ttoken: {\n\t\t\t\tread() {\n\t\t\t\t\treturn loggedUserVar()\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nconst cache = new InMemoryCache({typePolicies});\n\nexport class Gql {\n\tpublic apollo: ApolloClient<NormalizedCacheObject>;\n\n\tconstructor() {\n\t\tthis.apollo = this.initClient();\n\t}\n\n\tprivate initClient(): ApolloClient<NormalizedCacheObject> {\n\t\tconst client = new ApolloClient({\n\t\t\tcache,\n\t\t\ttypeDefs,\n\t\t\tlink: from([authLink, errorLink, middleware, afterware, httpLink])\n\t\t});\n\t\treturn client;\n\t}\n}\n\n// export const client = new Gql().apollo;\n\n\nexport const client = new ApolloClient<NormalizedCacheObject>({\n\tcache,\n\ttypeDefs,\n\tlink: from([authLink, errorLink, middleware, afterware, httpLink])\n});\n"]},"metadata":{},"sourceType":"module"}